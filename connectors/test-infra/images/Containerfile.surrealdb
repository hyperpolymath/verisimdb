# SPDX-License-Identifier: PMPL-1.0-or-later
#
# VeriSimDB Test Infrastructure — SurrealDB
#
# Builds SurrealDB on Chainguard wolfi-base. SurrealDB is a multi-model
# database that combines document, graph, and key-value capabilities —
# useful for testing federation across document and graph modalities
# simultaneously.
#
# Runs in memory mode for tests (no persistence overhead).
#
# Provides:
#   - HTTP API on port 8000 (REST + WebSocket)
#   - /health endpoint for readiness checks
#
# Author: Jonathan D.A. Jewell <j.d.a.jewell@open.ac.uk>

# ---------------------------------------------------------------------------
# Stage 1: Download SurrealDB binary
# ---------------------------------------------------------------------------
FROM cgr.dev/chainguard/wolfi-base:latest AS builder

RUN apk add --no-cache \
    curl \
    tar

ARG SURREALDB_VERSION=2.2.1
RUN curl -fsSL \
    "https://download.surrealdb.com/v${SURREALDB_VERSION}/surreal-v${SURREALDB_VERSION}.linux-amd64.tgz" \
    | tar xz -C /tmp \
    && install -m 0755 /tmp/surreal /usr/local/bin/surreal

# ---------------------------------------------------------------------------
# Stage 2: Runtime image
# ---------------------------------------------------------------------------
FROM cgr.dev/chainguard/wolfi-base:latest

RUN apk add --no-cache \
    libstdc++ \
    curl

# Copy SurrealDB binary
COPY --from=builder /usr/local/bin/surreal /usr/bin/surreal

# Create non-root user
RUN addgroup -g 1000 surrealdb \
    && adduser -u 1000 -G surrealdb -D -h /var/lib/surrealdb surrealdb

# Create data directory (used if persistent mode ever needed)
RUN mkdir -p /var/lib/surrealdb \
    && chown -R surrealdb:surrealdb /var/lib/surrealdb

USER surrealdb
WORKDIR /var/lib/surrealdb

EXPOSE 8000

HEALTHCHECK --interval=10s --timeout=5s --retries=5 --start-period=10s \
    CMD curl -sf http://localhost:8000/health || exit 1

# Default: memory mode, no auth, all interfaces
ENTRYPOINT ["surreal"]
CMD ["start", "--log", "info", "--bind", "0.0.0.0:8000", "memory"]
