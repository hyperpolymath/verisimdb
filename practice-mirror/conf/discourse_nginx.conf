# conf/discourse_nginx.conf
# Nginx configuration for Discourse

upstream discourse_puma {
  server unix:/var/www/discourse/tmp/sockets/puma.sock fail_timeout=0;
}

server {
  listen 80;
  listen [::]:80;
  server_name discourse.nuj-lcb.org.uk; # Replace with your domain

  # Redirect HTTP to HTTPS (assuming HTTPS termination elsewhere, e.g., svalinn)
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name discourse.nuj-lcb.org.uk; # Replace with your domain

  # SSL configuration (Svalinn will handle TLS termination typically)
  # For internal Nginx, placeholder SSL cert/key are needed,
  # or rely on upstream TLS termination.
  # ssl_certificate /etc/nginx/certs/discourse.crt;
  # ssl_certificate_key /etc/nginx/certs/discourse.key;
  # ssl_session_timeout 1d;
  # ssl_session_cache shared:SSL:10m;
  # ssl_session_tickets off;

  # Strict-Transport-Security (HSTS) - should be handled by Svalinn for the domain
  # add_header Strict-Transport-Security "max-age=63072000" always;

  # Load Balancing for Puma
  location / {
    proxy_pass http://discourse_puma;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 90;
    proxy_redirect off;
  }

  # Serve assets directly (optional, Discourse usually serves its own assets)
  # location ~* ^/(assets|uploads|images|stylesheets|javascripts|favicons)/ {
  #   root /var/www/discourse/public;
  #   expires max;
  #   add_header Cache-Control public;
  # }

  # Error pages
  error_page 500 502 503 504 /500.html;
  location = /500.html {
    root /var/www/discourse/public;
  }
}
